<script src="./node_modules/bluebird/js/browser/bluebird.js"></script>
<script src="./node_modules/ikagaka.nar.js/node_modules/encoding-japanese/encoding.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/jszip.min.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/XHRProxy.min.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/WMDescript.js"></script>
<script src="./node_modules/ikagaka.nar.js/Nar.js"></script>
<script src="./node_modules/ikagaka.shell.js/node_modules/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="./node_modules/underscore/underscore-min.js"></script>
<script src="./node_modules/ikagaka.shell.js/node_modules/zepto/zepto.min.js"></script>
<script src="./node_modules/ikagaka.shell.js/SurfaceUtil.js"></script>
<script src="./node_modules/ikagaka.shell.js/Surface.js"></script>
<script src="./node_modules/ikagaka.shell.js/Shell.js"></script>
<script src="./node_modules/ikagaka.sakurascriptplayer.js/node_modules/ikagaka.named.js/node_modules/ikagaka.balloon.js/BalloonSurface.js"></script>
<script src="./node_modules/ikagaka.sakurascriptplayer.js/node_modules/ikagaka.named.js/node_modules/ikagaka.balloon.js/Balloon.js"></script>
<script src="./node_modules/ikagaka.sakurascriptplayer.js/node_modules/ikagaka.named.js/Scope.js"></script>
<script src="./node_modules/ikagaka.sakurascriptplayer.js/node_modules/ikagaka.named.js/Named.js"></script>
<script src="./node_modules/ikagaka.sakurascriptplayer.js/SakuraScriptPlayer.js"></script>
<script src="./node_modules/ikagaka.ghost.js/Ghost.js"></script>
<script src="./node_modules/shiorijk/lib/shiorijk.js"></script>
<script>
Promise.resolve()
  .then(function(){ return new Promise(function(resolve, reject){
    var nar = new Nar();
    nar.loadFromURL("./node_modules/ikagaka.ghost.js/vender/net.narazaka.miyoforwebbw.nar", function(err){
      if(!!err) reject(err); else resolve(nar);
    });
  })}).then(function(nar){ return new Promise(function(resolve, reject){
    Promise.all([
      Promise.resolve(nar),
      new Promise(function(resolve, reject){
        var shell = new Shell(nar.getDirectory(/shell\/master\//));
        shell.load(function(err){
          if(!!err) return reject(err); else resolve(shell);
        });
      }),
      new Promise(function(resolve, reject){
        var ghost = new Ghost(nar.getDirectory(/ghost\/master\//));
        ghost.load(function(err){
          if(!!err) return reject(err); else resolve(ghost);
        });
      }),
      new Promise(function(resolve, reject){
        var nar = new Nar();
        nar.loadFromURL("./node_modules/ikagaka.sakurascriptplayer.js/node_modules/ikagaka.named.js/node_modules/ikagaka.balloon.js/vender/origin.nar", function(err){
          if(!!err) return reject(err);
          var balloon = new Balloon(nar.directory);
          balloon.load(function(err){
            if(!!err) return reject(err); else resolve(balloon);
          });
        });
      })
    ]).then(function(tmp){ resolve(tmp); })
    .catch(function(err){ reject(err); });
  })}).then(function(tmp){
    var nar = tmp[0];
    var shell = tmp[1];
    var ghost = tmp[2];
    var balloon = tmp[3];
    var named = new Named(shell, balloon);
    var ssp = new SakuraScriptPlayer(named);

    $(named.element)
      .on("IkagakaSurfaceEvent", function(ev){ requestSender(ev.detail); })
      .appendTo("body");

    requestSender({
      ID: "OnBoot",
      Sender: "embryo",
      Charset: "Shift_JIS",
      Reference0: "0"
    });

    setInterval(function(){
      requestSender({
        ID: "OnSecondChange",
        Sender: "embryo",
        Charset: "Shift_JIS",
        Reference0: "0",
        Reference1: "0",
        Reference2: "0",
        Reference3: "1"
      });
    }, 1000);

    function requestSender(ev){
      var request = new ShioriJK.Message.Request();
      request.request_line.method = "GET";
      request.request_line.protocol = "SHIORI";
      request.request_line.version = "3.0";
      console.log(ev);
      Object.keys(ev).forEach(function(key){
        request.headers.header[key] = ""+ev[key];
      });
      console.log(""+request);
      ghost.request(""+request, responseHandler);
    }
    function responseHandler(err, response){
      if(!!err) return console.error(err.stack);
      console.log(response);
      var parser = new ShioriJK.Shiori.Response.Parser();
      parsed = parser.parse(response);
      if(parsed.status_line.arguments.code === 200 &&
         typeof parsed.headers.header.Value === "string"){
        var ss = parsed.headers.header.Value;
        console.log(ss);
        ssp.play("\\1\\0"+ss);
      }
    }

  }).catch(function(err){ console.error(err, err.stack); });




</script>
