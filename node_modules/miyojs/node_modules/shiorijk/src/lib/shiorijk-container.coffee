Function::property = (properties) ->
	for property, descriptions of properties
		Object.defineProperty @prototype, property, descriptions

ShioriJK.Message = {}

class ShioriJK.Message.Request
	constructor : (options) ->
		unless options? and options.no_prepare
			@request_line = new ShioriJK.RequestLine()
			@headers = new ShioriJK.Headers.Request()
	toString : ->
		@request_line.toString() + '\r\n' + @headers.toString() + '\r\n'

class ShioriJK.Message.Response
	constructor : (options) ->
		unless options? and options.no_prepare
			@status_line = new ShioriJK.StatusLine()
			@headers = new ShioriJK.Headers.Response()
	toString : ->
		@status_line.toString() + '\r\n' + @headers.toString() + '\r\n'

class ShioriJK.RequestLine
	constructor : ->
		@arguments = {}
	@property
		method :
			get : -> @arguments.method
			set : (method) ->
				if method? and @version?
					@validate_method_version method, @version
				else if method?
					switch method
						when 'GET', 'NOTIFY', 'GET Version', 'GET Sentence', 'GET Word', 'GET Status', 'TEACH', 'GET String', 'NOTIFY OwnerGhostName', 'TRANSLATE Sentence'
						else
							throw 'Invalid protocol method : ' + method
				@arguments.method = method
		protocol :
			get : -> @arguments.protocol
			set : (protocol) ->
				if protocol? and protocol != 'SHIORI'
					throw 'Invalid protocol : ' + protocol
				@arguments.protocol = protocol
		version :
			get : -> @arguments.version
			set : (version) ->
				if @method? and version?
					@validate_method_version @method, version
				else if version?
					switch version
						when '2.0', '2.2', '2.3', '2.4', '2.5', '2.6', '3.0'
						else
							throw 'Invalid protocol version : ' + version
				@arguments.version = version
	validate_method_version : (method, version) ->
		is_valid = false
		switch version
			when '2.0'
				switch method
					when 'GET Version', 'NOTIFY', 'GET Sentence', 'GET Word', 'GET Status'
						is_valid = true
			when '2.2'
				switch method
					when 'GET Sentence'
						is_valid = true
			when '2.3'
				switch method
					when 'NOTIFY', 'GET Sentence'
						is_valid = true
			when '2.4'
				switch method
					when 'TEACH'
						is_valid = true
			when '2.5'
				switch method
					when 'GET String'
						is_valid = true
			when '2.6' # spec is unknown
				switch method
					when 'GET Sentence', 'GET Status', 'GET String', 'NOTIFY OwnerGhostName', 'GET Version', 'TRANSLATE Sentence'
						is_valid = true
			when '3.0'
				switch method
					when 'GET', 'NOTIFY'
						is_valid = true
		unless is_valid
			throw 'Invalid protocol method and version : ' + method + ' SHIORI/' + version
	toString : ->
		"#{@method} #{@protocol}/#{@version}"

class ShioriJK.StatusLine
	constructor : ->
		@arguments = {protocol: 'SHIORI'}
	@property
		code :
			get : -> @arguments.code
			set : (code) ->
				if code? and not @message[code]?
					throw 'Invalid response code : ' + code
				@arguments.code = code
		protocol :
			get : -> @arguments.protocol
			set : (protocol) ->
				if protocol? and protocol != 'SHIORI'
					throw 'Invalid protocol : ' + protocol
				@arguments.protocol = protocol
		version :
			get : -> @arguments.version
			set : (version) ->
				if version?
					switch version
						when '2.0', '2.2', '2.3', '2.4', '2.5', '2.6', '3.0'
						else
							throw 'Invalid protocol version : ' + version
				@arguments.version = version
	toString : ->
		"#{@protocol}/#{@version} #{@code} #{@message[@code]}"
	message :
		200 : 'OK'
		204 : 'No Content'
		310 : 'Communicate'
		311 : 'Not Enough'
		312 : 'Advice'
		400 : 'Bad Request'
		418 : "I'm a tea pot"
		500 : 'Internal Server Error'

class ShioriJK.Headers
	constructor : ->
		@header = {}
	toString : ->
		str = ''
		@validate()
		for name, value of @header
			str += "#{name}: #{value}\r\n"
		str
	validate : ->
		for name, value of @header
			if value.match /\n/
				throw 'Invalid header value - line feed found : [' + name + '] : ' + value
	get : (name) ->
		if @header[name]?
			@header[name]
	set : (name, value) ->
		@header[name] = value
	get_separated : (name, separator) ->
		unless separator?
			separator = '\x01'
		if @header[name]?
			@header[name].split separator
	set_separated : (name, value, separator) ->
		unless separator?
			separator = '\x01'
		@header[name] = value.join separator

class ShioriJK.Headers.Request extends ShioriJK.Headers

class ShioriJK.Headers.Response extends ShioriJK.Headers


