<script src="./node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/node_modules/encoding-japanese/encoding.js"></script>
<script src="./node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vender/jszip.min.js"></script>
<script src="./node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vender/XHRProxy.min.js"></script>
<script src="./node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vender/WMDescript.js"></script>
<script src="./node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/Nar.js"></script>
<script src="./node_modules/ikagaka.shell.js/node_modules/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="./node_modules/ikagaka.shell.js/node_modules/underscore/underscore-min.js"></script>
<script src="./node_modules/jquery/dist/jquery.min.js"></script>
<script src="./node_modules/ikagaka.shell.js/SurfaceUtil.js"></script>
<script src="./node_modules/ikagaka.shell.js/Surface.js"></script>
<script src="./node_modules/ikagaka.shell.js/Shell.js"></script>
<script src="./node_modules/ikagaka.balloon.js/BalloonSurface.js"></script>
<script src="./node_modules/ikagaka.balloon.js/Balloon.js"></script>
<script src="./vender/jquery-ui/core.js"></script>
<script src="./vender/jquery-ui/widget.js"></script>
<script src="./vender/jquery-ui/mouse.js"></script>
<script src="./vender/jquery-ui/draggable.js"></script>
<script src="./vender/jquery.ui.touch-punch.min.js"></script>
<script src="./Scope.js"></script>
<script src="./Named.js"></script>
<script>
Promise.all([
  new Promise(function(resolve, reject){
    var nar = new Nar();
    nar.loadFromURL("./node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vender/mobilemaster.nar", function(err){
      if(!!err) return reject(err);
      var shell = new Shell(nar.getDirectory(/shell\/master\//));
      shell.load(function(err){
        if(!!err) return reject(err);
        resolve(shell);
      });
    });
  }),
  new Promise(function(resolve, reject){
    var nar = new Nar();
    nar.loadFromURL("./node_modules/ikagaka.balloon.js/vender/origin.nar", function(err){
      if(!!err) return reject(err);
      var balloon = new Balloon(nar.directory);
      balloon.load(function(err){
        if(!!err) return reject(err);
        resolve(balloon);
      });
    });
  })
]).then(function(tmp){
  var shell = tmp[0];
  var balloon = tmp[1];
  var named = new Named(shell, balloon);

  console.log(named);

  $(named.element).appendTo("body")
  $(named.element).on("IkagakaSurfaceEvent", function(ev){
    console.log(ev.detail);
  });

  var text = "HELLO WORLD!"
  var text2;
  var i = -1;

  init();
  setTimeout(recur);

  function init(){
    text2 = text;
    i += 1;
    named.scope(i % 2);
    named.scope().surface(i);
    named.scope().blimp(0)
  }

  function recur(){
    if(text2.length === 0){
      named.scope(i % 2).blimp(0).br();
      init();
    }
    if(i % 7 === 0){
      named.scope().blimp().choice(text2, "helloworld");
      text2 = ""
    }else if(i % 7 === 3){
      named.scope().blimp().clear()
      text2 = ""
    }else if(i % 7 === 5){
      named.scope().blimp().br()
      text2 = ""
    }else{
      named.scope().blimp().talk(text2[0])
      text2 = text2.slice(1);
    }
    setTimeout(recur, 100);
  }
}).catch(function(err){ console.error(err.stack) });
</script>
