<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/node_modules/encoding-japanese/encoding.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vender/jszip.min.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vender/XHRProxy.min.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vender/WMDescript.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/Nar.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/jquery/dist/jquery.min.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/node_modules/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/node_modules/underscore/underscore-min.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/SurfaceUtil.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/Surface.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/Shell.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.balloon.js/BalloonSurface.js"></script>
<script src="./node_modules/ikagaka.named.js/node_modules/ikagaka.balloon.js/Balloon.js"></script>
<script src="./node_modules/ikagaka.named.js/Scope.js"></script>
<script src="./node_modules/ikagaka.named.js/Named.js"></script>
<script src="./SakuraScriptPlayer.js"></script>
nar: <input type="file" id="nar" /><br />
SakuraScript: <input type="text" value="\0\s[0]Hello World!\w8\n\1\s[10]Hello Web Ghost!\n\e" id="SakuraScript"/>
<input type="button" value="play" id="Play"/>
<script>



Promise.all([
  new Promise(function(resolve, reject){
    var nar = new Nar();
    nar.loadFromURL("./node_modules/ikagaka.named.js/node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vender/mobilemaster.nar", function(err){
      if(!!err) return reject(err);
      var shell = new Shell(nar.getDirectory(/shell\/master\//));
      shell.load(function(err){
        if(!!err) return reject(err);
        resolve(shell);
      });
    });
  }),
  new Promise(function(resolve, reject){
    var nar = new Nar();
    nar.loadFromURL("./node_modules/ikagaka.named.js/node_modules/ikagaka.balloon.js/vender/origin.nar", function(err){
      if(!!err) return reject(err);
      var balloon = new Balloon(nar.directory);
      balloon.load(function(err){
        if(!!err) return reject(err);
        resolve(balloon);
      });
    });
  })
]).then(function(tmp){
  var shell = tmp[0];
  var balloon = tmp[1];
  var named = new Named(shell, balloon);
  var ssp = new SakuraScriptPlayer(named);
  var ssps = [ssp];

  $(named.element)
    .appendTo("body")
    .on("IkagakaSurfaceEvent", function(ev){
      console.log(ev.detail);
    });

  $("#nar").change(function(ev){
    var nar = new Nar();
    nar.loadFromBlob(ev.target.files[0], function(err){
      if(!!err) return console.error(err.stack);
      var shell = new Shell(nar.getDirectory(/shell\/master\//));
      shell.load(function(err){
        if(!!err) return console.error(err.stack);
        var named = new Named(shell, balloon);
        var ssp = new SakuraScriptPlayer(named);
        console.log(named)
        ssps.push(ssp);
        $(named.element)
          .appendTo("body")
          .on("IkagakaSurfaceEvent", function(ev){
            console.log(ev.detail);
          });
        ssp.play("\\0\\s[0]\\1\\s[10]")
      });
    });
  });


  $("#Play").click(function(){
    var SakuraScript = $("#SakuraScript").val();

    console.log(SakuraScript);

    ssps.forEach(function(ssp){
      ssp.play(SakuraScript);
    });
  }).click();

}).catch(function(err){ console.error(err.stack) });




</script>
