<script src="./node_modules/ikagaka.nar.js/node_modules/encoding-japanese/encoding.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/jszip.min.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/XHRProxy.min.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/WMDescript.js"></script>
<script src="./node_modules/ikagaka.nar.js/Nar.js"></script>
<script src="./node_modules/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="./node_modules/underscore/underscore-min.js"></script>
<script src="./node_modules/jquery/dist/jquery.min.js"></script>
<script src="./node_modules/es6-shim/es6-shim.min.js"></script>
<script src="./SurfaceUtil.js"></script>
<script src="./Surface.js"></script>
<script src="./Shell.js"></script>
<p>
  nar: <input type="file" id="nar" />
  surface: <input type="number" value="0" id="surfaceId" />
</p>
<script>
$(function(){

  $("#nar").change(function(ev){
    var nar = new Nar();
    nar.loadFromBlob(ev.target.files[0], loadHandler.bind(this, nar));
  });

  var nar = new Nar();

  nar.loadFromURL("./node_modules/ikagaka.nar.js/vender/mobilemaster.nar", loadHandler.bind(this, nar));

  $("body").click(function(ev){
    console.log(ev);
  });
});


function loadHandler(nar, err){
  if(!!err) return console.error(err.stack);

  console.log(nar);

  if(nar.install["type"] === "ghost"){
    var shellDir = nar.getDirectory(/shell\/master\//);
    var shell = new Shell(shellDir);

  }else if(nar.install.type === "shell"){
    var shell = new Shell(nar.directory);

  }else{
    throw new Error("wrong nar file")
  }

  shell.load(function(err){
    if(!!err) return console.error(err.stack);

    console.log(shell);

    var $wrapper = $("<div style='display:inline-block;' />")
      .on("IkagakaSurfaceEvent", function(ev){
        console.log(ev);
      })
      .appendTo("body");
    var $canvas = $("<canvas />")
      .appendTo($wrapper);

    $("#surfaceId").change(function(ev){
      changeSurface(Number($(ev.target).val()));
    });

    var surface;

    changeSurface(0);

    setInterval(function(){
      if(surface != null){
        surface.talk();
      }
    }, 100);

    function changeSurface(n){
      if(surface != null){
        surface.destructor();
      }
      surface = shell.attachSurface($canvas[0], 0, n);
      
      console.log(surface);
    }

  });

}
</script>
