<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Ikagaka demo</title>
<script src="./node_modules/es6-shim/es6-shim.min.js"></script>
<script src="./node_modules/bluebird/js/browser/bluebird.js"></script>
<script src="./node_modules/encoding-japanese/encoding.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/WMDescript.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/jszip.min.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/XHRProxy.min.js"></script>
<script src="./node_modules/ikagaka.nar.js/Nar.js"></script>
<script src="./node_modules/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="./node_modules/underscore/underscore-min.js"></script>
<script src="./node_modules/jquery/dist/jquery.min.js"></script>
<script src="./node_modules/ikagaka.shell.js/SurfaceUtil.js"></script>
<script src="./node_modules/ikagaka.shell.js/Surface.js"></script>
<script src="./node_modules/ikagaka.shell.js/Shell.js"></script>
<script src="./node_modules/ikagaka.balloon.js/BalloonSurface.js"></script>
<script src="./node_modules/ikagaka.balloon.js/Balloon.js"></script>
<script src="./node_modules/ikagaka.named.js/vender/jquery-ui/core.js"></script>
<script src="./node_modules/ikagaka.named.js/vender/jquery-ui/widget.js"></script>
<script src="./node_modules/ikagaka.named.js/vender/jquery-ui/mouse.js"></script>
<script src="./node_modules/ikagaka.named.js/vender/jquery-ui/draggable.js"></script>
<script src="./node_modules/ikagaka.named.js/vender/jquery.ui.touch-punch.min.js"></script>
<script src="./node_modules/ikagaka.named.js/Scope.js"></script>
<script src="./node_modules/ikagaka.named.js/Named.js"></script>
<script src="./node_modules/ikagaka.sakurascriptplayer.js/SakuraScriptPlayer.js"></script>
<script src="./node_modules/ikagaka.ghost.js/Ghost.js"></script>
<script src="./node_modules/shiorijk/lib/shiorijk.js"></script>
<style>
/*
.surfaceCanvas {
  animation: breathing 6s linear 0s infinite normal;
}
@keyframes breathing {
  0% { transform: scale(1.0, 1.0); }
  20% { transform: scale(1.01, 1.02); }
  50% { transform: scale(1.05, 1.05); }
  80% { transform: scale(1.01, 1.02); }
  100% { transform: scale(1.0, 1.0); }
}*/
</style>
<script>
function load_nar(buffer){
Promise.all([
  new Promise(function(resolve, reject){
    var nar = new Nar();
//    nar.loadFromURL("./vender/goa_06.00.nar", function(err){
//   nar.loadFromURL("./vender/lv1_202.nar", function(err){
//   nar.loadFromURL("./vender/TempleteKarin.nar", function(err){
//   nar.loadFromURL("./vender/54_set43.nar", function(err){
//   nar.loadFromURL("./vender/Ageha.nar", function(err){
   nar.loadFromBuffer(buffer, function(err){
      if(!!err) return reject(err);
      Promise.all([
        new Promise(function(resolve, reject){
          var shell = new Shell(nar.getDirectory(/shell\/master\//));
          shell.load(function(err){
            if(!!err) reject(err); else resolve(shell);
          });
        }),
        new Promise(function(resolve, reject){
          var ghost = new Ghost(nar.getDirectory(/ghost\/master\//));
          ghost.load(function(err){
            if(!!err) reject(err); else resolve(ghost);
          });
        })
      ]).then(resolve).catch(reject);
    });
  }),
  new Promise(function(resolve, reject){
    var nar = new Nar();
    nar.loadFromURL("./node_modules/ikagaka.balloon.js/vender/origin.nar", function(err){
      if(!!err) return reject(err);
      var balloon = new Balloon(nar.directory);
      balloon.load(function(err){
        if(!!err) reject(err); else resolve(balloon);
      });
    });
  })
]).then(function(tmp){
  var shell = tmp[0][0];
  var ghost = tmp[0][1];
  var balloon = tmp[1];
  var named = new Named(shell, balloon);
  var ssp = new SakuraScriptPlayer(named);

  $(named.element)
    .on("IkagakaSurfaceEvent", function(ev){
      requestSender(ev.detail);
    })
    .appendTo("body");

  requestSender({
    ID: "OnBoot",
    Sender: "embryo",
    Charset: "Shift_JIS",
    Reference0: "0"
  });

  setInterval(function(){
    requestSender({
      ID: "OnSecondChange",
      Sender: "embryo",
      Charset: "Shift_JIS",
      Reference0: "0",
      Reference1: "0",
      Reference2: "0",
      Reference3: "1"
    });
  }, 1000);

  function requestSender(ev){
    var request = new ShioriJK.Message.Request();
    request.request_line.method = "GET";
    request.request_line.protocol = "SHIORI";
    request.request_line.version = "3.0";
    request.headers.header["Sender"] = "embryo";
    request.headers.header["Charset"] = "Shift_JIS";
    Object.keys(ev).forEach(function(key){
      request.headers.header[key] = ""+ev[key];
    });
    console.log(""+request);
    ghost.request(""+request, responseHandler);
  }
  function responseHandler(err, response){
    if(!!err) return console.error(err.stack);
    console.log(response);
    var parser = new ShioriJK.Shiori.Response.Parser();
    parsed = parser.parse(response);
    if(parsed.status_line.arguments.code === 200 &&
       typeof parsed.headers.header.Value === "string"){
      var ss = parsed.headers.header.Value;
      console.log(ss);
      ssp.play("\\1\\0"+ss);
    }
  }

}).catch(function(err){ alert(err); console.error(err, err.stack); });
}

function handleFileSelect(event){
	var file = event.target.files[0];
	var reader = new FileReader();
	reader.onload = function(event){
		var nar = event.target.result;
		load_nar(nar);
	};
	reader.readAsArrayBuffer(file);
}

window.onload = function(){
	document.getElementById('nar').addEventListener('change', handleFileSelect, false);
};
</script>
</head>
<body>
<h1>如何かテスト</h1>
<p>
<a href="https://github.com/Ikagaka" target="_blank">Webベースウェア「如何か」</a>(に組み込まれている拙作SHIORIモジュール)のテスト。
</p>
<p>
IE10+,Fx?,Chrome対応。
</p>
<p>
<label>
<strong>
narを選択してください。
<input type='file' id="nar">
</strong>
</label>
</p>
<p>
SAORIを使用しない華和梨・里々・YAYAのnarか、標準のプラグインしか含めないMiyoJSなら読めるかも。
</p>
<h2><strong>起動</strong>確認が取れたゴースト</h2>
<h3>華和梨</h3>
<ul>
<li><a href="http://khmix.sakura.ne.jp/ghost.shtml" target="_blank">GOA Lilith</a></li>
<li><a href="http://spoon.if.land.to/wiki/index.php?%B2%DA%CF%C2%CD%FC%A5%C6%A5%F3%A5%D7%A5%EC%A1%BC%A5%C8Ghost%A1%D8%A3%CC%A3%F6%A3%B1(%A4%EC%A4%D9%A4%EB%A4%A4%A4%C1)%A1%D9" target="_blank">れべるいち</a></li>
<li><a href="http://rimuhamate.sakura.ne.jp/KarinDocument/" target="_blank">かりん</a></li>
<li><a href="http://priest.so.land.to/ghost/wish.html" target="_blank">wish</a></li>
<li><a href="http://paripari.if.land.to/" target="_blank">パリパリ</a></li>
<li><a href="http://www11.ocn.ne.jp/~feconf/" target="_blank">ブリュンヒルデ</a></li>
<li><a href="https://dl.dropboxusercontent.com/u/28020825/kuro8/index.html" target="_blank">偽黒姉・偽ひより</a></li>
<li><a href="http://ms.shillest.net/shiories.xhtml" target="_blank">SHIORIES</a></li>
<li><a href="http://www.vector.co.jp/soft/win95/edu/se342728.html" target="_blank">化学っ娘ノエリ</a></li>
</ul>
<h3>里々</h3>
<ul>
<li><a href="http://www.kuromi.jp/nanika/nanika_unknown.html" target="_blank">里々スクリプト学習ゴースト learning.nar</a></li>
<li><a href="http://sgmh.sakura.ne.jp/tcg/kit/" target="_blank">ゴーストキット</a></li>
<li><a href="http://1boshi.eek.jp/ghost.html" target="_blank">アコとなかまたちver2.0</a></li>
<li><a href="http://1boshi.eek.jp/ghost14.html" target="_blank">神無月コトシロくん</a></li>
<li><a href="http://haka.sakura.ne.jp/simcity/" target="_blank">偽シムシティ(シェルの問題で表示が不正確)</a></li>
<li><a href="http://yuidoku.hotcom-web.com/" target="_blank">よろず請け負います</a></li>
<li><a href="http://review.sakura.ne.jp/?id=324" target="_blank">わはー＆危い</a></li>
</ul>
<h3>MiyoJS</h3>
<ul>
<li><a href="http://narazaka.net/c/ukagaka/dl.cgi?f=net.narazaka.miyoforwebbw.nar&d=ghost/net.narazaka.miyoforwebbw" target="_blank">MiyoPreview機能限定版</a></li>
</ul>
<h3>YAYA</h3>
<p>現在boostをSTLに置換した影響で、容易に機能を置換できなかった正規表現の「//m,//s,//x」については無効になっています。これらを使用しているゴーストは正しく動かない可能性があります。</p>
<ul>
<li><a href="http://ms.shillest.net/yayame.xhtml" target="_blank">紺野ややめ</a></li>
</ul>
<h2>動作報告</h2>
<p>起動・動作・バグ報告を募集します。</p>
<p>○○が起動・動作した、動作したが未知っぽい原因でおかしい、その他気づいたことなど、色々お願いします。</p>
<p>できれば一応IE、Fx、Chrome等の開発者ツールでバグの原因をある程度特定してお願いします。</p>
<p>Githubユーザーの方は<a href="https://github.com/Ikagaka/Ikagaka.demo/issues" target="_blank">Issues</a>へ。</p>
<p>そうでない方、あるいは単純な起動報告等は<a href="http://uka.jpn.org/test/read.cgi/unyu/1416718339/l50" target="_blank">如何か開発スレッド</a>へ。</p>
<ul>
<li>SAORIを含まない華和梨・里々・YAYA・MiyoJSを使用したゴーストが動作します。</li>
<li>華和梨・里々はSAORI対応を除くフル機能、YAYAは現状では正規表現オプションに制約を持つ機能対応となっています。この制約の元でおかしなところがあればご報告ください。</li>
<li>さくらスクリプトは未対応のものが多いですが、対応していそうなやつでバグが出てたらご報告ください。 </li>
<li>シェル関連も読み込み時エラーや動作時エラーがありえます。動作に関しては未実装なものもあります。これについてもお願いします。</li>
<li>多重起動はできますが、現状は各ゴーストが単体で動いていて相互の管理がなされていない擬似的なものです。これについてのバグ報告はお待ちください。</li>
<li>「dlopen」が関連するエラーはSAORIが原因ですので報告していただかなくてかまいません。</li>
<li>バグ報告はすぐ処理されるとは限りません。忙しい上にやることは山ほどあるのでものによってはめっちゃ放置がありえます。</li>
</ul>
</body>
</html>
